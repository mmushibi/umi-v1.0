<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Creation Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-4">User Creation & Login Test</h1>
        
        <div class="mb-4">
            <h2 class="text-lg font-semibold mb-2">Test User Creation</h2>
            <button onclick="testUserCreation()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Create Test User
            </button>
            <div id="creationResult" class="mt-2 text-sm"></div>
        </div>
        
        <div class="mb-4">
            <h2 class="text-lg font-semibold mb-2">Test User Login</h2>
            <button onclick="testUserLogin()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                Test Login
            </button>
            <div id="loginResult" class="mt-2 text-sm"></div>
        </div>
        
        <div class="mb-4">
            <h2 class="text-lg font-semibold mb-2">Test Frontend Integration</h2>
            <button onclick="testFrontendIntegration()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                Test Frontend
            </button>
            <div id="frontendResult" class="mt-2 text-sm"></div>
        </div>
    </div>

    <script>
        async function testUserCreation() {
            const result = document.getElementById('creationResult');
            result.innerHTML = 'Testing...';
            
            try {
                // Test backend API first
                const response = await fetch('/api/usermanagement/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: 'Test User',
                        email: 'test@example.com',
                        phone: '+260123456789',
                        role: 'pharmacist',
                        branch: 'Main Branch',
                        password: 'Test123!'
                    })
                });
                
                if (response.ok) {
                    const user = await response.json();
                    result.innerHTML = '<span class="text-green-600">✅ User created successfully via backend API!</span>';
                } else {
                    // Fallback to localStorage
                    const users = JSON.parse(localStorage.getItem('umi_users_list') || '[]');
                    users.push({
                        id: Date.now().toString(),
                        name: 'Test User',
                        email: 'test@example.com',
                        phone: '+260123456789',
                        role: 'pharmacist',
                        branch: 'Main Branch',
                        status: 'active',
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    });
                    localStorage.setItem('umi_users_list', JSON.stringify(users));
                    
                    // Store credentials for login
                    const credentials = JSON.parse(localStorage.getItem('umi_users') || '{}');
                    credentials['test@example.com'] = {
                        password: 'Test123!',
                        role: 'pharmacist'
                    };
                    localStorage.setItem('umi_users', JSON.stringify(credentials));
                    
                    result.innerHTML = '<span class="text-yellow-600">⚠️ Backend unavailable, user created in localStorage</span>';
                }
            } catch (error) {
                // Fallback to localStorage
                const users = JSON.parse(localStorage.getItem('umi_users_list') || '[]');
                users.push({
                    id: Date.now().toString(),
                    name: 'Test User',
                    email: 'test@example.com',
                    phone: '+260123456789',
                    role: 'pharmacist',
                    branch: 'Main Branch',
                    status: 'active',
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                });
                localStorage.setItem('umi_users_list', JSON.stringify(users));
                
                // Store credentials for login
                const credentials = JSON.parse(localStorage.getItem('umi_users') || '{}');
                credentials['test@example.com'] = {
                    password: 'Test123!',
                    role: 'pharmacist'
                };
                localStorage.setItem('umi_users', JSON.stringify(credentials));
                
                result.innerHTML = '<span class="text-yellow-600">⚠️ Backend unavailable, user created in localStorage</span>';
            }
        }
        
        async function testUserLogin() {
            const result = document.getElementById('loginResult');
            result.innerHTML = 'Testing...';
            
            try {
                // Test backend API first
                const response = await fetch('/api/auth/signin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'Test123!'
                    })
                });
                
                if (response.ok) {
                    const authResult = await response.json();
                    result.innerHTML = '<span class="text-green-600">✅ User login successful via backend API!</span>';
                } else {
                    // Fallback to localStorage
                    const credentials = JSON.parse(localStorage.getItem('umi_users') || '{}');
                    const userCredentials = credentials['test@example.com'];
                    
                    if (userCredentials && userCredentials.password === 'Test123!') {
                        result.innerHTML = '<span class="text-yellow-600">⚠️ Backend unavailable, login successful via localStorage</span>';
                    } else {
                        result.innerHTML = '<span class="text-red-600">❌ Login failed - credentials not found</span>';
                    }
                }
            } catch (error) {
                // Fallback to localStorage
                const credentials = JSON.parse(localStorage.getItem('umi_users') || '{}');
                const userCredentials = credentials['test@example.com'];
                
                if (userCredentials && userCredentials.password === 'Test123!') {
                    result.innerHTML = '<span class="text-yellow-600">⚠️ Backend unavailable, login successful via localStorage</span>';
                } else {
                    result.innerHTML = '<span class="text-red-600">❌ Login failed - credentials not found</span>';
                }
            }
        }
        
        async function testFrontendIntegration() {
            const result = document.getElementById('frontendResult');
            result.innerHTML = 'Testing...';
            
            try {
                // Test if signin page can find the user
                const credentials = JSON.parse(localStorage.getItem('umi_users') || '{}');
                const users = JSON.parse(localStorage.getItem('umi_users_list') || '[]');
                
                const testUser = users.find(u => u.email === 'test@example.com');
                const testCredentials = credentials['test@example.com'];
                
                if (testUser && testCredentials) {
                    result.innerHTML = '<span class="text-green-600">✅ Frontend integration ready! User can login at signin.html</span>';
                } else {
                    result.innerHTML = '<span class="text-yellow-600">⚠️ Create user first</span>';
                }
            } catch (error) {
                result.innerHTML = `<span class="text-red-600">❌ Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
